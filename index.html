<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#000000">
    <meta name="description" content="Relational Causal Engine">
    <title>Causal Stack Lab</title>
    <link rel="manifest" href="data:application/manifest+json;base64,eyJuYW1lIjoiRGlzY3JldGUgQ2F1c2FsIExhYiIsInNob3J0X25hbWUiOiJDYXVzYWxpdHkiLCJkaXNwbGF5IjoiZnVsbHNjcmVlbiIsImJhY2tncm91bmRfY29sb3IiOiIjMDAwMDAwIiwidGhlbWVfY29sb3IiOiIjMDAwMDAwIiwiaWNvbnMiOlt7InNyYyI6Imh0dHBzOi8vaW1nLmljb25zOC5jb20vY29sb3IvMTkyL2RvbXluby5wbmciLCJzaXplcyI6IjE5MngxOTIiLCJ0eXBlIjoiaW1hZ2UvcG5nIn1dfQ==">
    <link rel="apple-touch-icon" href="https://img.icons8.com/color/192/domyno.png">
    
    <!-- LIBRARIES -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- KaTeX -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <!-- Chart.js & PDF -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

    <style>
        /* --- CORE RESET --- */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none;}
        :root { --bg: #050505; --accent: #f59e0b; --glass: rgba(20, 20, 25, 0.95); --border: rgba(255,255,255,0.15); }
        body { background: var(--bg); color: #e2e8f0; font-family: 'Inter', monospace; height: 100dvh; width: 100vw; overflow: hidden; margin: 0; position: fixed; }
        
        #app-container { position: absolute; inset: 0; width: 100%; height: 100%; overflow: hidden; }
        .page { position: absolute; inset: 0; transition: transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1); background: var(--bg); z-index: 10; display: flex; flex-direction: column; }
        .page.hidden-right { transform: translateX(100%); z-index: 20; }
        .page.hidden-left { transform: translateX(-30%); opacity: 0.5; }
        
        canvas { width: 100%; height: 100%; outline: none; display: block; touch-action: none;}
        .grid-bg { background-image: linear-gradient(rgba(255,255,255,0.03) 1px, transparent 1px), linear-gradient(90deg, rgba(255,255,255,0.03) 1px, transparent 1px); background-size: 40px 40px; }
        
        .glass { background: var(--glass); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-top: 1px solid var(--border); }
        .glass-panel { background: rgba(255,255,255,0.02); border: 1px solid var(--border); border-radius: 4px; }
        .btn-round { width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; background: rgba(255,255,255,0.05); border: 1px solid var(--border); transition: 0.2s; color: white; cursor: pointer; }
        .btn-round:active { transform: scale(0.9); background: var(--accent); color: black; }
        
        .stat-row { display: flex; justify-content: space-between; font-size: 10px; font-family: 'Courier New', monospace; border-bottom: 1px solid rgba(255,255,255,0.05); padding: 6px 0; }
        .stat-lbl { opacity: 0.5; text-transform: uppercase; letter-spacing: 1px; }
        .stat-val { color: var(--accent); font-weight: bold; }
        
        .tab-scroller { display: flex; overflow-x: auto; scrollbar-width: none; -ms-overflow-style: none; white-space: nowrap; mask-image: linear-gradient(to right, black 90%, transparent 100%); }
        .tab-btn { padding: 12px 16px; font-size: 10px; font-weight: 800; opacity: 0.5; transition: 0.2s; border-bottom: 2px solid transparent; letter-spacing: 0.05em; color: #94a3b8; font-family: monospace; }
        .tab-btn.active { opacity: 1; color: var(--accent); border-color: var(--accent); }
        
        input[type=range] { -webkit-appearance: none; background: transparent; height: 24px; width: 100%; cursor: pointer; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 2px; background: rgba(255,255,255,0.2); }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 12px; width: 12px; border-radius: 0; background: var(--accent); margin-top: -5px; box-shadow: 0 0 10px var(--accent); border: 1px solid black; }
        select, input[type=text], textarea { background: rgba(0,0,0,0.5); border: 1px solid var(--border); color: var(--accent); font-family: monospace; font-size: 10px; padding: 4px; width: 100%; outline: none; }
        
        .safe-top { padding-top: max(12px, env(safe-area-inset-top)); }
        .cinema-mode #ui-layer { display: none !important; }
        .cinema-mode #drawer { display: none !important; }
        .cinema-mode canvas { cursor: none; }
        
        /* Documentation Styling */
        .doc-section h2 { color: var(--accent); font-size: 1.1rem; font-weight: bold; margin: 2rem 0 0.5rem 0; border-bottom: 2px solid var(--border); padding-bottom: 8px; text-transform: uppercase; letter-spacing: 1px; }
        .doc-section h3 { color: #fff; font-size: 0.9rem; font-weight: bold; margin: 1.5rem 0 0.5rem 0; border-left: 2px solid var(--accent); padding-left: 10px; }
        .doc-section p { font-size: 0.85rem; line-height: 1.6; color: #bbb; margin-bottom: 1rem; }
        .doc-section code { background: rgba(255,255,255,0.05); color: var(--accent); padding: 2px 4px; font-family: monospace; border-radius: 3px; }
        .doc-table { width: 100%; border-collapse: collapse; margin: 1rem 0; font-size: 0.8rem; background: rgba(255,255,255,0.02); }
        .doc-table th, .doc-table td { border: 1px solid var(--border); padding: 8px; text-align: left; }
        .doc-table th { color: var(--accent); text-transform: uppercase; background: rgba(255,255,255,0.03); }
        .boxed-math { padding: 16px; background: rgba(255,255,255,0.03); border: 1px solid var(--border); margin: 1.5rem 0; text-align: center; border-radius: 4px; }
        .recipe-box { border: 1px dashed var(--accent); padding: 12px; margin: 1rem 0; border-radius: 4px; background: rgba(245, 158, 11, 0.05); }
        .export-btn { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 12px; background: rgba(255,255,255,0.03); border: 1px solid var(--border); border-radius: 4px; transition: all 0.2s; color: #a3a3a3; cursor: pointer; }
    </style>
</head>
<body>

<div id="app-container">
    
    <!-- === HOME SCREEN === -->
    <div id="page-home" class="page">
        <header class="p-6 safe-top bg-gradient-to-b from-zinc-900 to-transparent border-b border-white/5 shrink-0">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-2xl font-mono font-bold text-amber-500 tracking-tighter">CAUSAL<span class="text-white">LAB</span></h1>
                    <p class="text-[9px] uppercase tracking-[0.2em] opacity-60 font-mono mt-2">Relational Computation Engine</p>
                </div>
                <div class="w-8 h-8 border border-amber-500/50 flex items-center justify-center">
                    <i class="fas fa-network-wired text-amber-500 text-xs"></i>
                </div>
            </div>
        </header>
        <div class="flex-1 overflow-y-auto p-4 safe-bottom space-y-4" id="algo-list"></div>
    </div>

    <!-- === SIMULATION SCREEN === -->
    <div id="page-sim" class="page hidden-right">
        <div class="absolute inset-0 z-0 bg-black grid-bg">
            <canvas id="simCanvas"></canvas>
        </div>
        
        <!-- UI OVERLAY -->
        <div id="ui-layer" class="absolute inset-0 z-10 flex flex-col pointer-events-none">
            <div class="pointer-events-auto bg-black/80 backdrop-blur border-b border-white/10 p-2 safe-top flex items-center justify-between">
                <button onclick="App.goBack()" class="btn-round" title="Back"><i class="fas fa-chevron-left text-[10px]"></i></button>
                <div class="text-center">
                    <div id="sim-title" class="text-[10px] font-mono text-amber-500 uppercase"></div>
                    <div class="flex gap-2 justify-center items-center mt-0.5"><span class="text-[8px] opacity-50 font-mono" id="view-mode-lbl">MEMORY STACK VIEW</span></div>
                </div>
                <div class="flex gap-4 items-center">
                    <button onclick="App.togglePause()" id="play-btn" class="btn-round bg-amber-600 border-none text-black"><i class="fas fa-pause text-[10px]"></i></button>
                    <button onclick="App.step()" class="btn-round" title="Single Step"><i class="fas fa-step-forward text-[10px]"></i></button>
                    <button onclick="App.reset()" class="btn-round" title="Reset"><i class="fas fa-redo text-[10px]"></i></button>
                </div>
                <button onclick="App.toggleCinema()" class="btn-round text-amber-400 border-amber-500/30" title="Fullscreen"><i class="fas fa-expand text-[10px]"></i></button>
            </div>
            <div class="absolute top-20 right-4 pointer-events-auto flex flex-col gap-2">
                <button onclick="App.adjustZoom(1.1)" class="btn-round bg-black/50"><i class="fas fa-plus text-[10px]"></i></button>
                <button onclick="App.adjustZoom(0.9)" class="btn-round bg-black/50"><i class="fas fa-minus text-[10px]"></i></button>
            </div>
            <div id="toast" class="absolute top-20 left-1/2 -translate-x-1/2 bg-zinc-800 text-white font-mono text-[10px] px-4 py-2 border border-amber-500/20 opacity-0 transition-opacity pointer-events-none flex items-center gap-2 z-50 rounded-full shadow-xl">
                <span id="toast-msg"></span>
            </div>
        </div>

        <!-- DRAWER -->
        <div id="drawer" class="absolute bottom-0 left-0 right-0 z-20 pointer-events-auto flex flex-col h-[50dvh] transition-transform duration-300 translate-y-0 bg-zinc-950 border-t border-white/10 shadow-[0_-10px_60px_rgba(0,0,0,0.9)]">
            <div class="w-full h-6 flex items-center justify-center shrink-0 cursor-pointer active:opacity-50 border-b border-white/5 hover:bg-white/5" onclick="App.toggleDrawer()">
                <div class="w-8 h-1 bg-white/20 rounded-full"></div>
            </div>
            <div class="border-b border-white/10 shrink-0 bg-black/20">
                <div class="tab-scroller px-2">
                    <button onclick="App.setTab('controls')" class="tab-btn active" data-tab="controls">GENERATOR</button>
                    <button onclick="App.setTab('metrics')" class="tab-btn" data-tab="metrics">METRICS</button>
                    <button onclick="App.setTab('phase')" class="tab-btn" data-tab="phase">PHASE</button>
                    <button onclick="App.setTab('export')" class="tab-btn" data-tab="export">EXPORT</button>
                    <button onclick="App.setTab('docs')" class="tab-btn" data-tab="docs">MANUAL</button>
                </div>
            </div>

            <div class="flex-1 overflow-y-auto p-5 pb-24 relative bg-black/40" id="drawer-content">
                <div id="tab-controls" class="space-y-6">
                    <div id="std-header" class="glass-panel p-4 flex items-center justify-center min-h-[50px]"><div id="katex-eq" class="text-xs text-amber-100"></div></div>
                    <div id="custom-editor" class="hidden space-y-4">
                        <textarea id="eqn-input" rows="2" oninput="CustomMode.onTextChange(this.value)">u_new = u_0 + alpha*u_1</textarea>
                        <div id="parse-error" class="text-[9px] text-red-500 hidden"></div>
                        <div class="glass-panel p-0 max-h-[100px] overflow-y-auto"><table class="w-full text-[10px] font-mono"><tbody id="coeff-body"></tbody></table></div>
                    </div>
                    <div class="space-y-4">
                        <div class="control-group"><div class="flex justify-between text-[10px] mb-1 opacity-80"><span>Parameter α</span><span id="lbl-k" class="font-mono">0.05</span></div><input type="range" id="inp-k" min="-0.5" max="0.5" step="0.001" value="0.05" oninput="CustomMode.onParamChange()"></div>
                        <div class="control-group"><div class="flex justify-between text-[10px] mb-1 opacity-80"><span>Initial Past</span></div><select id="inp-initMode"><option value="flat">Flat</option><option value="pulse">Pulse</option><option value="harmonic">Harmonic</option><option value="noise">Noise</option></select></div>
                        <div class="glass-panel p-3 flex justify-between items-center border-l-2 border-purple-500/50">
                            <div><div class="text-[10px] font-bold text-purple-400">Enable 3D Intuition</div><div class="text-[8px] opacity-60">Visual Aid Only</div></div>
                            <input type="checkbox" id="inp-3d" class="accent-purple-500 w-4 h-4 cursor-pointer">
                        </div>
                    </div>
                </div>
                <div id="tab-metrics" class="hidden h-full space-y-4">
                    <div class="glass-panel p-4"><h3 class="text-[10px] font-bold text-amber-500 uppercase border-b border-white/10 pb-2 mb-2">Stability Trace</h3><div class="h-32 w-full relative"><canvas id="normCanvas"></canvas></div><div class="stat-row mt-2"><span class="stat-lbl">Max Norm</span><span id="val-max-norm" class="stat-val">--</span></div></div>
                    <div class="glass-panel p-4"><div class="stat-row"><span class="stat-lbl">Value (u_0)</span><span id="val-u" class="stat-val">--</span></div><div class="stat-row"><span class="stat-lbl">Growth Rate</span><span id="val-growth" class="stat-val">--</span></div></div>
                </div>
                <div id="tab-phase" class="hidden h-full"><div class="glass-panel p-2 min-h-[200px]"><canvas id="phaseCanvas"></canvas></div></div>
                <div id="tab-export" class="hidden h-full"><div class="grid grid-cols-2 gap-3"><button onclick="Export.generatePDF()" class="export-btn"><i class="fas fa-file-pdf text-red-500 mb-1"></i><span>PDF</span></button><button onclick="Export.downloadCSV()" class="export-btn"><i class="fas fa-file-csv text-green-500 mb-1"></i><span>CSV</span></button></div></div>
                <div id="tab-docs" class="hidden h-full doc-section pb-20"></div>
            </div>
        </div>
    </div>
</div>

<script>
/* --- PHYSICS KERNEL --- */
const Physics = {
    discrete: {
        outward: function(h, p) { return (1 + p.alpha) * h[0]; },
        custom_linear: function(h, p) { 
            var sum=0; 
            CustomMode.coeffs.forEach(function(c,j){ if(h[j]!==undefined) sum+=c*h[j]; }); 
            return sum; 
        }
    }
};

const Models = [
    { id: 'custom_linear', title: 'User Generator', eq: 'u_{new} = \\sum c_j u_j', init: 1, p: function(){return {};}, fn: 'custom_linear', type: 'scalar', custom: true },
    { id: 'outward', title: 'Causal Recursion', eq: 'u_{new} = (1+\\alpha)u_{now}', init: 1, p: function(k){return {alpha:k};}, fn: 'outward', type: 'scalar' }
];

/* --- CUSTOM MODE LOGIC --- */
const CustomMode = {
    coeffs: [], rawText: "u_new = u_0 + alpha*u_1",
    init: function() { this.coeffs=[1.0, 0.05]; this.updateTable(); },
    onTextChange: function(txt) {
        this.rawText = txt; var errEl = document.getElementById('parse-error');
        try {
            var parts = txt.split('='); var rhs = (parts[1] || parts[0]).trim();
            var terms = rhs.replace(/-/g, '+-').split('+').map(function(t){return t.trim();}).filter(function(t){return t;});
            var newC = []; var inpK = document.getElementById('inp-k'); var alpha = inpK ? parseFloat(inpK.value) : 0;
            terms.forEach(function(t) {
                var match = t.match(/u_(\d+)/); if(!match) return;
                var d = parseInt(match[1]);
                var cStr = t.split('u_')[0].trim(); 
                if(cStr.substring(cStr.length-1) === '*') cStr = cStr.substring(0, cStr.length-1).trim();
                var v = 1.0;
                if(cStr==='alpha') v=alpha; else if(cStr==='-alpha') v=-alpha; else if(cStr==='-'||cStr==='+-') v=-1.0; else if(cStr!==''&&cStr!=='+') v=parseFloat(cStr);
                newC[d] = (newC[d]||0) + v;
            });
            this.coeffs = newC; for(var i=0; i<this.coeffs.length; i++) if(this.coeffs[i]===undefined) this.coeffs[i]=0;
            if(errEl) errEl.classList.add('hidden'); this.updateTable(); App.reset();
        } catch(e) { if(errEl) { errEl.innerText = "Error: "+e.message; errEl.classList.remove('hidden'); } }
    },
    onParamChange: function() { 
        var eqn = document.getElementById('eqn-input'); var lblK = document.getElementById('lbl-k'); var inpK = document.getElementById('inp-k');
        if(eqn && lblK && inpK) { this.onTextChange(eqn.value); lblK.innerText = inpK.value; }
    },
    onTableChange: function(d, v) { this.coeffs[d] = parseFloat(v)||0; App.reset(); },
    updateTable: function() {
        var b = document.getElementById('coeff-body'); if(!b) return;
        b.innerHTML='';
        for(var i=0; i<=(this.coeffs.length||1); i++) {
            b.innerHTML += '<tr><td class="p-1 opacity-50">u_' + i + '</td><td class="p-1 text-right"><input class="bg-transparent border-b border-white/20 text-right w-12" value="' + (this.coeffs[i]||0) + '" onchange="CustomMode.onTableChange(' + i + ',this.value)"></td></tr>';
        }
    }
};

/* --- APP CONTROLLER --- */
const App = {
    state: { active: null, running: true, history: [], runLog: [], params: { k: 0.05, mem: 20, acausal: false, initMode: 'flat', is3D: false }, view: { zoom: 1, cx: 0, cy: 0 }, runId: '', stepCount: 0, touch: { lastTap: 0, initialDist: 0, initialZoom: 1 } },
    
    init: function() {
        this.state.runId = Math.random().toString(36).substring(2, 11);
        var metaId = document.getElementById('meta-id'); if (metaId) metaId.innerText = this.state.runId;
        CustomMode.init(); this.populateMenu(); this.loadModel(Models[0]);
        this.setupInputs(); this.resize();
        window.addEventListener('resize', function(){ App.resize(); });
        this.initCharts();
        requestAnimationFrame(function(){ App.loop(); });
        this.populateManual();
    },

    populateManual: function() {
        var t = document.getElementById('tab-docs'); if (!t) return;
        t.innerHTML = '<h2>CAUSAL STACK LAB: User & Research Manual</h2>' +
            '<p><em>A Causal Functional-Dynamics Engine</em></p>' +
            '<h3>0. Purpose of This Manual</h3>' +
            '<p>This manual serves New Users, Students, and Researchers. The same software supports all three—only the interpretation of results differs.</p>' +
            '<h3>1. What This Software Is</h3>' +
            '<p>Causal Stack Lab evolves systems where the future is generated from structured past memory stack, not merely from the present state.</p>' +
            '<div class="boxed-math">$$ u_{n+1} = G(u_n, u_{n-1}, u_{n-2}, \\dots) $$</div>' +
            '<p>Such relations arise in radiation reaction, control theory, and non-Markovian dynamics.</p>' +
            '<h3>2. What This Software Is NOT</h3>' +
            '<p>This software is NOT an ODE/PDE solver. It does not assume smooth limits or enforce stability artificially. If a model fails here, it is because the physics fails, not the code.</p>' +
            '<h3>3. Core Concept: Time as Memory</h3>' +
            '<p>Time is implemented as an ordered memory stack: $u_0$ (present), $u_1$ (1-step past), up to $u_j$. There is no future access by construction.</p>' +
            '<h3>4. Initial Past Specification</h3>' +
            '<p>Requires an initial history function: $ u(t < 0) = \\phi(t) $. Presets include Flat (constant) and Harmonic (sinusoidal).</p>' +
            '<h3>5. Two Ways to Define Dynamics</h3>' +
            '<p><strong>Mode A (Symbolic):</strong> Write equations like <code>u_new = (1+alpha)*u_0</code>. Sliders control symbols.</p>' +
            '<p><strong>Mode B (Table):</strong> Set equation to <code>u_new = u_0</code>. Use the Coefficient Table to define kernels manually.</p>' +
            '<div class="recipe-box">' +
            '<h3>Canonical Test: Failure of Keplerian Past</h3>' +
            '<p>Set <code>u_new = u_0</code>, choose <strong>Harmonic</strong> past, then use Table coefficients: (0: 1.0, 1: -0.95, 2: 0.15). Observe how phase drift emerges structurally.</p>' +
            '</div>' +
            '<h3>Student vs Researcher Interpretation</h3>' +
            '<h4>For Students</h4>' +
            '<p>Focus on how changing the rule changes behavior. Do not try to "stabilize" models—simply observe their natural evolution.</p>' +
            '<h4>For Researchers</h4>' +
            '<p>Interpret instability as a structural property of the generator. No tolerance-based validation is performed; results are exact products of the law.</p>' +
            '<h3>Final Principle</h3>' +
            '<p><em>"This software does not correct physics. It reveals it."</em></p>';
        if(window.renderMathInElement) renderMathInElement(t, {delims:[{left:"$$",right:"$$",display:true}, {left:"$",right:"$",display:false}], throwOnError:false});
    },

    populateMenu: function() {
        var l = document.getElementById('algo-list'); if (!l) return;
        l.innerHTML=''; var self = this;
        Models.forEach(function(mod) {
            var b=document.createElement('button'); b.className="w-full text-left bg-zinc-900 border border-white/5 p-3 mb-2 hover:border-amber-500/50 active:bg-zinc-800";
            b.innerHTML='<div class="font-bold text-xs text-amber-500">' + mod.title + '</div><div class="text-[9px] opacity-60 font-mono mt-1">$' + mod.eq + '$</div>';
            b.onclick=function(){ self.loadModel(mod); }; l.appendChild(b);
        });
        if(window.renderMathInElement) renderMathInElement(l, {delims:[{left:"$",right:"$",display:false}], throwOnError:false});
    },

    loadModel: function(m) {
        this.state.active = m; var titleEl = document.getElementById('sim-title'); if (titleEl) titleEl.innerText = m.title;
        var stdHeader = document.getElementById('std-header'); var customEditor = document.getElementById('custom-editor');
        if(m.custom) { if(stdHeader) stdHeader.classList.add('hidden'); if(customEditor) customEditor.classList.remove('hidden'); }
        else { if(stdHeader) stdHeader.classList.remove('hidden'); if(customEditor) customEditor.classList.add('hidden'); var ke = document.getElementById('katex-eq'); if(ke) katex.render(m.eq, ke, {throwOnError:false}); }
        document.getElementById('page-home').classList.add('hidden-left'); document.getElementById('page-sim').classList.remove('hidden-right');
        this.reset();
    },

    reset: function() {
        this.state.history = []; this.state.stepCount = 0;
        var active = this.state.active; var initVal = active.init; var mode = this.state.params.initMode;
        for(var i=0; i<200; i++) {
            var s = mode==='pulse'?(i>20&&i<30?2:0):(mode==='harmonic'?Math.sin(i*0.1):1);
            if(active.type==='vector') this.state.history.push({E:initVal.E*s, B:initVal.B*s});
            else this.state.history.push(initVal*s);
        }
        if(window.normChart) { window.normChart.data.labels=[]; window.normChart.data.datasets[0].data=[]; window.normChart.update(); }
        var pc = document.getElementById('phaseCanvas'); if(pc) pc.getContext('2d').clearRect(0,0,pc.width,pc.height);
    },

    togglePause: function() { this.state.running = !this.state.running; var pb = document.getElementById('play-btn'); if(pb) pb.innerHTML = this.state.running ? '<i class="fas fa-pause text-[10px]"></i>' : '<i class="fas fa-play text-[10px]"></i>'; },
    step: function() { this.state.running = false; this.updatePhysics(); this.render(); },
    loop: function() { if(this.state.running) this.updatePhysics(); this.render(); requestAnimationFrame(function(){ App.loop(); }); },
    updatePhysics: function() {
        var active = this.state.active; var fn = Physics.discrete[active.fn]; var nextVal = fn(this.state.history, this.state.params);
        this.state.history.unshift(nextVal); if(this.state.history.length > 300) this.state.history.pop();
        this.analyze(nextVal, this.state.history[1]); this.state.stepCount++;
    },

    analyze: function(curr, prev) {
        var active = this.state.active; var norm = active.type==='scalar' ? Math.abs(curr) : Math.hypot(curr.E, curr.B);
        var prevNorm = prev ? (active.type==='scalar' ? Math.abs(prev) : Math.hypot(prev.E, prev.B)) : 1;
        var growth = prevNorm > 1e-9 ? norm/prevNorm : 1;
        if(this.state.stepCount % 5 === 0) {
            if(window.normChart) { window.normChart.data.labels.push(this.state.stepCount); window.normChart.data.datasets[0].data.push(norm); if(window.normChart.data.labels.length > 50) { window.normChart.data.labels.shift(); window.normChart.data.datasets[0].data.shift(); } window.normChart.update('none'); }
            var pc = document.getElementById('phaseCanvas');
            if(pc && prev) {
                var ctx = pc.getContext('2d'); var w = pc.width, h = pc.height, cx = w/2, cy = h/2, scale = h/4; ctx.fillStyle = 'rgba(245,158,11,0.5)';
                var x = active.type==='vector'?curr.E:curr, y = active.type==='vector'?curr.B:prev; ctx.fillRect(cx + x*scale, cy - y*scale, 2, 2);
            }
        }
        var mnel = document.getElementById('val-max-norm'); if(mnel) mnel.innerText = norm.toFixed(4);
        var uel = document.getElementById('val-u'); if(uel) uel.innerText = (active.type === 'scalar' ? curr.toFixed(4) : curr.E.toFixed(4));
        var gel = document.getElementById('val-growth'); if(gel) gel.innerText = growth.toFixed(5);
    },

    render: function() {
        var cvs = document.getElementById('simCanvas'); if(!cvs) return;
        var ctx = cvs.getContext('2d'); var w = cvs.width, h = cvs.height; ctx.clearRect(0,0,w,h);
        ctx.save(); ctx.translate(w/2 + this.state.view.cx, h/2 + this.state.view.cy); ctx.scale(this.state.view.zoom, this.state.view.zoom);
        var hist = this.state.history; ctx.strokeStyle = '#f59e0b'; ctx.lineWidth = 2; ctx.beginPath();
        for(var i=0; i<Math.min(hist.length, 200); i++) {
            var val = (this.state.active.type==='scalar') ? hist[i] : hist[i].E;
            ctx.lineTo((100-i)*5, -val*50);
        }
        ctx.stroke(); ctx.restore();
    },

    setupInputs: function() {
        var c = document.getElementById('simCanvas'); var self = this;
        if (c) {
            var isDrag = false, lx=0, ly=0;
            c.onpointerdown = function(e) { isDrag=true; lx=e.clientX; ly=e.clientY; c.setPointerCapture(e.pointerId); };
            c.onpointermove = function(e) { if(!isDrag) return; self.state.view.cx += e.clientX-lx; self.state.view.cy += e.clientY-ly; lx=e.clientX; ly=e.clientY; self.render(); };
            c.onpointerup = function(e) { isDrag=false; };
            c.addEventListener('touchstart', function(e) {
                var now = Date.now(); if (now - self.state.touch.lastTap < 300) { if (document.body.classList.contains('cinema-mode')) self.toggleCinema(); }
                self.state.touch.lastTap = now;
                if (e.touches.length === 2) { var dx=e.touches[0].clientX-e.touches[1].clientX, dy=e.touches[0].clientY-e.touches[1].clientY; self.state.touch.initialDist=Math.sqrt(dx*dx+dy*dy); self.state.touch.initialZoom=self.state.view.zoom; }
                else if(e.touches.length===1) { lx=e.touches[0].clientX; ly=e.touches[0].clientY; }
            }, {passive: false});
            c.addEventListener('touchmove', function(e) {
                if (e.touches.length === 2) { e.preventDefault(); var dx=e.touches[0].clientX-e.touches[1].clientX, dy=e.touches[0].clientY-e.touches[1].clientY; var d=Math.sqrt(dx*dx+dy*dy); self.state.view.zoom=self.state.touch.initialZoom*(d/self.state.touch.initialDist); self.render(); }
                else if(e.touches.length===1) { self.state.view.cx+=e.touches[0].clientX-lx; self.state.view.cy+=e.touches[0].clientY-ly; lx=e.touches[0].clientX; ly=e.touches[0].clientY; self.render(); }
            }, {passive: false});
        }
        var ik = document.getElementById('inp-k'); if(ik) ik.oninput = function(e) { self.state.params.k = parseFloat(e.target.value); var lbl = document.getElementById('lbl-k'); if(lbl) lbl.innerText = e.target.value; CustomMode.onParamChange(); };
        var im = document.getElementById('inp-initMode'); if(im) im.onchange = function(e) { self.state.params.initMode = e.target.value; self.reset(); };
    },
    
    adjustZoom: function(f) { this.state.view.zoom *= f; this.render(); },
    toggleCinema: function() { document.body.classList.toggle('cinema-mode'); try { if(!document.fullscreenElement) { document.documentElement.requestFullscreen().catch(function(){}); } else { document.exitFullscreen().catch(function(){}); } } catch (e) {} },
    toggleDrawer: function() { var d=document.getElementById('drawer'); if(d) d.style.transform = d.style.transform==='translateY(0px)'||d.style.transform==='' ? 'translateY(85%)' : 'translateY(0px)'; },
    setTab: function(id) { document.querySelectorAll('.tab-btn').forEach(function(b){b.classList.remove('active');}); var targetBtn = document.querySelector('button[data-tab="' + id + '"]'); if(targetBtn) targetBtn.classList.add('active'); ['controls','metrics','phase','export','docs'].forEach(function(t){var el=document.getElementById('tab-'+t); if(el) el.classList.add('hidden');}); var targetTab = document.getElementById('tab-'+id); if(targetTab) targetTab.classList.remove('hidden'); },
    goBack: function() { this.state.running=false; document.getElementById('page-home').classList.remove('hidden-left'); document.getElementById('page-sim').classList.add('hidden-right'); },
    showToast: function(msg) { var t=document.getElementById('toast'); var tm=document.getElementById('toast-msg'); if (t && tm) { tm.innerText=msg; t.style.opacity=1; setTimeout(function(){t.style.opacity=0;},2000); } },
    resize: function() { var c = document.getElementById('simCanvas'); var p = document.getElementById('phaseCanvas'); if(c) { c.width = c.clientWidth; c.height = c.clientHeight; } if(p) { p.width = p.clientWidth; p.height = p.clientHeight; } this.render(); },
    initCharts: function() {
        var cvs = document.getElementById('normCanvas'); if (!cvs) return;
        window.normChart = new Chart(cvs.getContext('2d'), { type: 'line', data: { labels: [], datasets: [{ label: 'Norm', data: [], borderColor: '#f59e0b', borderWidth: 1, pointRadius: 0 }] }, options: { responsive: true, maintainAspectRatio: false, animation: false, plugins: { legend: {display: false} }, scales: { x: {display:false}, y: {grid:{color:'rgba(255,255,255,0.1)'}} } } });
    }
};

const Export = {
    downloadCSV: function() { var csv = "Depth,Value\n"; App.state.history.forEach(function(v,i){ csv += i + ',' + (App.state.active.type==='vector'?v.E:v) + '\n'; }); var a = document.createElement("a"); a.href = 'data:text/csv;charset=utf-8,' + encodeURIComponent(csv); a.download = 'causal_data.csv'; a.click(); },
    generatePDF: function() { if(!window.jspdf) return; var doc = new window.jspdf.jsPDF(); doc.text("Causal Stack Report", 20, 20); doc.addImage(document.getElementById('simCanvas').toDataURL(), 'PNG', 20, 30, 170, 80); doc.save('report.pdf'); }
};

window.addEventListener('DOMContentLoaded', function() { App.init(); });
</script>
</body>
</html>
